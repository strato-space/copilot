# Validation queries for STR OpsPortal ontology v1
# Run after each ingestion batch.

# 1) Basic cardinalities
match
  $p isa project;
get $p;
count;

match
  $t isa oper_task;
get $t;
count;

match
  $s isa voice_session;
get $s;
count;

# 2) Project -> Task links
match
  $rel (owner_project: $p, oper_task: $t) isa project_has_oper_task;
  $p has project_id $project_id;
  $t has task_id $task_id;
get $project_id, $task_id;
limit 50;

# 3) VoiceSession -> VoiceMessage links
match
  $rel (voice_session: $s, voice_message: $m) isa voice_session_has_message;
  $s has voice_session_id $session_id;
  $m has voice_message_id $message_id;
get $session_id, $message_id;
limit 50;

# 4) Forecast rows linked to project
match
  $rel (owner_project: $p, forecast_project_month: $f) isa project_has_forecast_month;
  $p has project_id $project_id;
  $f has month_key $month;
  $f has amount_rub $amount_rub;
get $project_id, $month, $amount_rub;
limit 50;

# 5) FinOps expenses linked to category
match
  $rel (cost_category: $c, cost_expense: $e) isa cost_category_classifies_expense;
  $c has name $category_name;
  $e has cost_expense_id $expense_id;
get $category_name, $expense_id;
limit 50;

# 6) High-risk orphan checks (should return 0)
# 6.1 OperTask without Project relation
match
  $t isa oper_task;
  not {
    (owner_project: $p, oper_task: $t) isa project_has_oper_task;
  };
get $t;
count;

# 6.2 VoiceMessage without VoiceSession relation
match
  $m isa voice_message;
  not {
    (voice_session: $s, voice_message: $m) isa voice_session_has_message;
  };
get $m;
count;

# 6.3 ForecastProjectMonth without Project relation
match
  $f isa forecast_project_month;
  not {
    (owner_project: $p, forecast_project_month: $f) isa project_has_forecast_month;
  };
get $f;
count;

# 7) Spot-check status normalization
match
  $t isa oper_task, has status $status;
get $status;
limit 20;

# 8) Spot-check ID normalization (all should be string attributes present)
match
  $s isa voice_session, has voice_session_id $sid;
get $sid;
limit 20;

match
  $p isa project, has project_id $pid;
get $pid;
limit 20;

# 9) Voice runtime-contract spot checks
# 9.1 Session logs linked to sessions
match
  $rel (voice_session: $s, history_step: $h) isa voice_session_has_history_step;
  $s has voice_session_id $session_id;
  $h has event_name $event_name;
get $session_id, $event_name;
limit 50;

# 9.2 Merge logs linked to target sessions
match
  $rel (target_session: $s, merge_log: $l) isa voice_session_has_merge_log;
  $s has voice_session_id $target_session_id;
  $l has operation_type $operation_type;
get $target_session_id, $operation_type;
limit 50;

# 9.3 Session close contract: inactive + to_finalize sessions should have done_at
match
  $s isa voice_session, has is_active false, has to_finalize true;
  not { $s has done_at $done; };
get $s;
count;

# 9.4 Pending anchor contract: pending image anchors should point to an existing session message
match
  $s isa voice_session, has pending_image_anchor_message_id $anchor_id;
  not {
    $m isa voice_message, has voice_message_id $anchor_id;
    (voice_session: $s, voice_message: $m) isa voice_session_has_message;
  };
get $s, $anchor_id;
limit 50;

# 9.5 Linked anchor contract: message.image_anchor_message_id should point to existing message
match
  $m isa voice_message, has image_anchor_message_id $anchor_id;
  not { $anchor isa voice_message, has voice_message_id $anchor_id; };
get $m, $anchor_id;
limit 50;

# 9.6 Runtime-tag completeness counters for runtime-scoped voice collections
match
  $s isa voice_session;
  not { $s has runtime_tag $runtime_tag; };
get $s;
count;

match
  $m isa voice_message;
  not { $m has runtime_tag $runtime_tag; };
get $m;
count;

match
  $l isa voice_session_merge_log;
  not { $l has runtime_tag $runtime_tag; };
get $l;
count;

# 10) OperTask/Codex runtime-contract checks
# 10.1 VoiceSession -> OperTask links (spot-check)
match
  $rel (source_voice_session: $s, sourced_oper_task: $t) isa voice_session_sources_oper_task;
  $s has voice_session_id $session_id;
  $t has task_id $task_id;
get $session_id, $task_id;
limit 50;

# 10.2 Codex tasks must stay linked to a project
match
  $t isa oper_task, has codex_task true;
  not {
    (owner_project: $p, oper_task: $t) isa project_has_oper_task;
  };
get $t;
count;

# 10.3 Tasks with source_ref should have VoiceSession relation materialized
match
  $t isa oper_task, has source_ref $source_ref;
  not {
    (source_voice_session: $s, sourced_oper_task: $t) isa voice_session_sources_oper_task;
  };
get $t, $source_ref;
limit 50;

# 10.4 Codex task lineage requires at least one session reference (source_ref or external_ref)
match
  $t isa oper_task, has codex_task true;
  not { $t has source_ref $source_ref; };
  not { $t has external_ref $external_ref; };
get $t;
count;

# 10.5 Deferred review contract: state=deferred should include due_at
match
  $t isa oper_task, has codex_review_state "deferred";
  not { $t has codex_review_due_at $due_at; };
get $t;
count;

# 10.6 Deferred review summary contract: generated summary must include summary text
match
  $t isa oper_task, has codex_review_summary_generated_at $generated_at;
  not { $t has codex_review_summary $summary; };
get $t, $generated_at;
count;

# 10.7 Codex project readiness: linked project should have git_repo
match
  $t isa oper_task, has codex_task true;
  (owner_project: $p, oper_task: $t) isa project_has_oper_task;
  not { $p has git_repo $git_repo; };
get $t, $p;
count;

# 10.8 Runtime-tag completeness counters for runtime-scoped task collection
match
  $t isa oper_task;
  not { $t has runtime_tag $runtime_tag; };
get $t;
count;

# 11) Source boundary note
# Validation here covers MongoDB-ingested ontology entities.
# BD-only Codex issues exposed via /api/crm/codex/* are intentionally out of scope for this query pack.

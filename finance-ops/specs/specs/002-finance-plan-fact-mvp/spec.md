# Спецификация фичи: Finance Ops Console — план‑факт и прогноз (MVP)

**Ветка фичи**: `002-finance-plan-fact-mvp`  
**Создано**: 2026-01-22  
**Статус**: Draft  
**Ввод**: описание пользователя: "finance.md + TZ.md"

## Пользовательские сценарии и тестирование *(обязательно)*

### User Story 1 — План‑факт по проектам (Приоритет: P1)

Руководитель открывает главный экран и видит KPI и таблицу план‑факт по клиентам/проектам с фокусом 3 месяца и горизонтом года.

**Почему такой приоритет**: это ядро продукта; без него нет базовой управленческой картины.

**Independent Test**: достаточно открыть экран «План‑факт» и увидеть KPI + таблицу с факт/прогнозом по месяцам.

**Acceptance Scenarios**:

1. **Given** выбран год и доступны данные CRM, **When** пользователь открывает «План‑факт», **Then** видит KPI и таблицу с факт/прогнозом по каждому проекту.
2. **Given** пользователь выбирает другой «главный месяц», **When** он кликает по заголовку месяца, **Then** KPI пересчитываются для выбранного месяца.

---

### User Story 2 — Редактирование факта через Drawer (Приоритет: P1)

Пользователь открывает Drawer по ячейке месяца и корректирует факт для T&M или Fix с проверками и аудитом.

**Почему такой приоритет**: корректность факта — критична для финансового контроля.

**Independent Test**: открыть Drawer, изменить факт, увидеть пересчёт суммы и запись в audit‑log.

**Acceptance Scenarios**:

1. **Given** месяц открыт и задана ставка T&M, **When** пользователь вводит `billed_hours`, **Then** сумма в RUB пересчитывается и сохраняется с audit‑записью.
2. **Given** проект Fix в USD без FX, **When** пользователь вводит сумму и ручной FX без комментария, **Then** сохранение блокируется и требуется комментарий.

---

### User Story 3 — Закрытие месяца (lock) (Приоритет: P2)

Руководитель закрывает месяц, чтобы зафиксировать факт и запретить правки.

**Почему такой приоритет**: без lock невозможно управлять периодами и финальной отчётностью.

**Independent Test**: закрыть месяц и убедиться, что факт не редактируется.

**Acceptance Scenarios**:

1. **Given** все блокирующие проверки пройдены, **When** пользователь подтверждает закрытие месяца, **Then** месяц получает статус `closed` и факт становится read‑only.
2. **Given** месяц закрыт, **When** пользователь пытается изменить факт, **Then** изменение запрещено и отображается статус lock.

---

### User Story 4 — Прогноз, версии и Copy Forecast (Приоритет: P2)

Пользователь ведёт прогноз в отдельных версиях и копирует прогноз вперёд для ускорения планирования.

**Почему такой приоритет**: прогноз — ключевой инструмент управления, но не блокирует базовый plan‑fact.

**Independent Test**: создать новую версию прогноза и скопировать прогноз на следующий месяц.

**Acceptance Scenarios**:

1. **Given** активная версия прогноза, **When** пользователь создаёт новую версию из текущей, **Then** новая версия появляется и может быть активирована.
2. **Given** выбраны source и target months, **When** выполняется Copy Forecast в режиме `fill_zero`, **Then** заполняются только пустые значения в target month.

---

### User Story 5 — Себестоимость, маржа и аналитика (Приоритет: P2)

Пользователь видит себестоимость и маржу, а также KPI/alerts/графики в аналитике.

**Почему такой приоритет**: управленческая ценность возникает, когда видно не только выручку, но и маржу.

**Independent Test**: открыть аналитику и увидеть KPI + список внимания + график выручки.

**Acceptance Scenarios**:

1. **Given** есть `billable hours` и зарплаты, **When** система рассчитывает cost, **Then** маржа в ₽ и % отображается в KPI и в деталях проекта.
2. **Given** есть отклонения по правилам алертов, **When** пользователь открывает аналитику, **Then** видит список внимания и может перейти к проекту/месяцу.

---

### User Story 6 — Запрос агенту K2 (Приоритет: P3)

Пользователь формирует запрос агенту K2 из контекста проекта/месяца и применяет правки с аудитом.

**Почему такой приоритет**: повышает скорость корректировок, но может быть выпущен позже базового функционала.

**Independent Test**: создать запрос, получить правку и применить её с audit‑меткой `agent`.

**Acceptance Scenarios**:

1. **Given** пользователь создал запрос, **When** агент возвращает изменения, **Then** пользователь может применить их и увидеть `agent` в audit‑логах.
2. **Given** месяц закрыт, **When** агент пытается изменить факт, **Then** правка блокируется.

---

### Edge Cases / Пограничные случаи

- Попытка правки факта в закрытом месяце.
- Отсутствует ставка T&M при вводе часов.
- Отсутствует FX для USD‑факта.
- `working_hours = 0` → частичная себестоимость.
- CRM‑данные устарели > 1 часа.
- Конфликт сохранения из‑за устаревшего `row_version`.
- Вложения превышают лимит или неподдерживаемый тип.
- Превышение лимита часов Fix (если задан `fix_hour_cap_total`).

### Non‑goals (MVP)

- Нет полного биллинга/выставления счетов и учёта оплат.
- Нет полного HR/payroll‑контура (кроме ввода зарплат для cost).
- Нет мультивалютности, кроме USD.
- Нет клиентских кабинетов.
- Нет мобильных приложений.
- Нет продвинутой BI/ML‑аналитики beyond KPI/alerts и K2‑запросов.

## Требования *(обязательно)*

### Функциональные требования

- **FR-001**: Система ДОЛЖНА показывать план‑факт по проектам на год с фокусом 3 месяца и группировкой по клиентам.
- **FR-002**: В каждой ячейке месяца ДОЛЖНЫ отображаться факт и прогноз (двухстрочный формат) с суммой в ₽ и часами.
- **FR-003**: KPI‑карточки ДОЛЖНЫ пересчитываться для выбранного «главного месяца».
- **FR-004**: Система ДОЛЖНА поддерживать `T&M` и `Fix`; для `Fix` факт/прогноз вводится только суммой.
- **FR-005**: Выручка для `T&M` ДОЛЖНА считаться как `hours × rate`, для `Fix` — `amount × fx_avg_month`.
- **FR-006**: Источник FX — средний курс ЦБ РФ за месяц; ручной FX допускается только с обязательным комментарием.
- **FR-007**: CRM‑данные ДОЛЖНЫ обновляться не реже одного раза в час; при устаревании > 1 часа показывается warning.
- **FR-008**: Себестоимость ДОЛЖНА считаться как `billable hours × cost rate`, где `cost rate = salary / working_hours`.
- **FR-009**: Маржа ДОЛЖНА быть доступна в ₽ и % для проекта и месяца.
- **FR-010**: Редактирование факта/прогноза ДОЛЖНО происходить через Drawer, не inline.
- **FR-011**: Валидации: запрет отрицательных значений; ставка обязательна для T&M; lock запрещает правки факта.
- **FR-012**: Система ДОЛЖНА поддерживать версии прогноза (создание, переключение активной, baseline).
- **FR-013**: Copy Forecast ДОЛЖЕН поддерживать source/target month, режимы `overwrite` и `fill_zero`, выбор проектов.
- **FR-014**: Закрытие месяца ДОЛЖНО блокировать изменения факта; изменения ставок после закрытия влияют только на прогноз.
- **FR-015**: Все изменения ДОЛЖНЫ фиксироваться в audit‑log с `actor_type` и `changes`.
- **FR-016**: Вложения ДОЛЖНЫ поддерживать типы `pdf/xlsx/csv/png/jpg` и лимит 25 MB/файл.
- **FR-017**: Аналитика ДОЛЖНА показывать KPI, список внимания и графики выручки/часов/маржи.
- **FR-018**: Система ДОЛЖНА поддерживать фильтры/поиск по клиенту/проекту/типу и фильтр «только риски».
- **FR-019**: Навигация ДОЛЖНА быть через side‑nav с разделами Plan‑Fact, Analytics, Settings.
- **FR-020**: Система ДОЛЖНА поддерживать workflow запросов агенту K2 с подтверждением применения правок.
- **FR-021**: Система ДОЛЖНА предоставлять экраны настроек справочников (клиенты, проекты, ставки, FX, исполнители, зарплаты, алерты).

### Ключевые сущности *(если фича про данные)*

- **Client**: клиент, владелец проектов.
- **Project**: проект/подпроект, тип контракта (`T&M`/`Fix`), лимит часов Fix (опционально).
- **Employee**: исполнитель.
- **TimesheetMonth**: часы по проекту/месяцу/исполнителю (`actual`, `billable`).
- **FactProjectMonth**: факт за месяц (часы/суммы/FX).
- **ForecastProjectMonth**: прогноз за месяц (часы/суммы/FX) + версия.
- **ForecastVersion**: версия прогноза (manual/auto, active, locked).
- **EmployeeMonthCost**: зарплата и cost‑rate за месяц.
- **FxMonthly**: курс месяца (USD→RUB, auto/manual).
- **Period**: статус месяца (open/closed).
- **Attachment**: файл, связанный с сущностью.
- **AuditEvent**: событие аудита.
- **AgentRequest**: запрос к K2 и его статус.

## IA & UX Flow *(если есть многошаговые сценарии)*

### Sitemap
- План‑факт
- Аналитика
- Настройки (клиенты/проекты/ставки/FX/исполнители/зарплаты/алерты)

### Навигационная модель
- Side‑nav с основными разделами; внутри настроек — список справочников.

### Route map
- `/plan-fact` → `screen.plan_fact`
- `/analytics` → `screen.analytics`
- `/settings` → `screen.settings`
- `/settings/projects` → `screen.settings.projects`
- `/settings/rates` → `screen.settings.rates`
- `/settings/fx` → `screen.settings.fx`
- `/settings/employees` → `screen.settings.employees`
- `/settings/salaries` → `screen.settings.salaries`
- `/settings/alerts` → `screen.settings.alerts`

### Ключевые состояния экранов
- **Plan‑Fact**: default / loading / empty / error / locked‑month indicators
- **Drawer**: default / loading / readonly / error
- **Analytics**: default / loading / empty / error
- **Settings**: default / loading / empty / error

## Masterpages *(если есть UI)*

**App Shell**
- Slots: side‑nav, top bar (год/версия/действия), основной контент.
- Scroll model: content scroll.

**Drawer/Overlay**
- Slots: header (project/month/lock), body (tabs), footer (actions).
- Focus trap + Esc для закрытия.

## Контракты компонентов *(если есть UI)*

**KPI Card**
- Props: `title`, `value`, `delta_primary`, `delta_secondary`, `info_text`
- States: default/positive/negative/loading
- Events: `onInfoClick`

**PlanFactGridCell**
- Props: `month`, `fact_rub`, `fact_hours`, `forecast_rub`, `forecast_hours`, `flags[]`, `locked`
- States: default/locked/warning/empty
- Events: `onOpenDrawer`

**ForecastVersionSelector**
- Props: `versions[]`, `activeVersionId`, `locked`
- Events: `onChange`, `onCreateFromActive`

**AlertsList**
- Props: `alerts[]` (type, severity, link)
- Events: `onAlertClick`

**CopyForecastModal**
- Props: `sourceMonth`, `targetMonth`, `mode`, `projects[]`
- Events: `onApply`, `onCancel`

**AgentRequestForm**
- Props: `projectId`, `month`, `scope`, `requestText`
- Events: `onSubmit`, `onCancel`

## Допущения и зависимости

- CRM предоставляет проекты/исполнителей/таймшиты и обновляется раз в час.
- Источник FX (ЦБ РФ) доступен для получения среднего курса за месяц.
- Доступ к системе — внутренний, в MVP только роль админ/руководитель.
- Доступно файловое хранилище для вложений с лимитом 25 MB/файл.

## Критерии успеха *(обязательно)*

### Измеримые результаты

- **SC-001**: Главный экран «План‑факт» отображается ≤ 5 сек при 1000 проектах.
- **SC-002**: 95% правок факта отражаются в таблице ≤ 10 сек после сохранения.
- **SC-003**: 100% попыток редактирования закрытого месяца отклоняются.
- **SC-004**: Расчёт выручки и маржи соответствует правилам с погрешностью округления ≤ 1 ₽.
- **SC-005**: Данные CRM обновляются не реже 1 раза в час; при задержке > 1 часа показывается предупреждение.

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WebRTC Audio Capture with Silence Detection</title>
    <link rel="icon" href="data:," />
    <style>
      * { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 12px; overflow-x: hidden; }
      body { background:#f8fafc; color:#0f172a; }
      h1 { font-size: 20px; line-height: 1.15; margin: 4px 0 6px; white-space: normal; overflow-wrap: anywhere; color: #0f172a; }
      .card { background:#fff; border-radius:10px; padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,0.05); border:1px solid #eee; max-width:100%; }
      .stack { display:flex; flex-direction:column; gap:6px; }
      .row { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
      .session-row-1, .session-row-2 { flex-wrap: nowrap; }
      .toolbar { flex-wrap: nowrap; align-items: center; }
      .toolbar .btn { white-space: nowrap; }
      /* Modern "control dock" look for action buttons */
      .toolbar {
        border-radius: 18px;
        padding: 10px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(14px);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      }
      .toolbar .btn {
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(15, 23, 42, 0.04);
        color: #0f172a;
        font-weight: 650;
        letter-spacing: 0.01em;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.72);
        transition: transform 120ms ease, background 160ms ease, border-color 160ms ease;
      }
      .toolbar .btn:hover { background: rgba(15, 23, 42, 0.06); }
      .toolbar .btn:active { transform: translateY(1px); }
      .toolbar .btn:disabled { box-shadow: none; }

      /* Action accents (only when enabled; disabled must look disabled) */
      #start-btn:not(:disabled) { background: rgba(59, 130, 246, 0.10); border-color: rgba(59, 130, 246, 0.22); color: #1d4ed8; }
      #record-btn:not(:disabled) { background: rgba(239, 68, 68, 0.10); border-color: rgba(239, 68, 68, 0.22); color: #b91c1c; }
      #chunk-btn:not(:disabled) { background: rgba(15, 23, 42, 0.04); }
      #pause-btn:not(:disabled) { background: rgba(234, 179, 8, 0.10); border-color: rgba(234, 179, 8, 0.22); color: #a16207; }
      #btn-done-button:not(:disabled) { background: rgba(34, 197, 94, 0.12); border-color: rgba(34, 197, 94, 0.24); color: #047857; }
      #btn-choose-file:not(:disabled) { background: rgba(59, 130, 246, 0.06); border-color: rgba(59, 130, 246, 0.16); color: #2563eb; }
      #btn-reset:not(:disabled) { background: rgba(148, 163, 184, 0.12); border-color: rgba(148, 163, 184, 0.22); color: #334155; }
      #btn-logout-app:not(:disabled) { background: rgba(239, 68, 68, 0.10); border-color: rgba(239, 68, 68, 0.24); color: #b91c1c; }
      #btn-logout,
      #btn-logout-app { display: none !important; }
      .settings-row-label { min-width: 220px; display: inline-block; }
      /* MacBook-sized screens: tighten labels and allow wrapping to avoid overflow */
      @media (max-width: 1440px) {
        .settings-row-label { min-width: 180px; }
        .session-row-1, .session-row-2 { flex-wrap: wrap; }
        .toolbar { gap: 6px; }
      }
      @media (max-width: 640px) {
        .settings-row-label { min-width: 140px; }
        .form-grid { grid-template-columns: 1fr 2fr; }
      }
      .settings-row-value { color: #64748b; }
      /* Small screens: condense toolbar buttons and show icons only for marked buttons */
      @media (max-width: 480px) {
        .toolbar .btn { padding: 6px 6px; }
        .btn.icon-on-small { position: relative; }
        .btn.icon-on-small span.lbl { display: none; }
        .btn.icon-on-small::before { content: attr(data-icon); font-size: 16px; display: inline-block; }
      }
      .form-grid { display:grid; grid-template-columns: 1fr 3fr; column-gap:6px; row-gap:4px; align-items:center; }
      .bar { width: 100%; height:8px; background:#f1f5f9; border-radius:999px; overflow:hidden; border:1px solid #e2e8f0; position: relative; }
      .bar-tick { position:absolute; top:-2px; bottom:-2px; width:2px; background:#f59e0b; opacity:0.9; left:0%; }
      .bar-tick.gate { background:#2563eb; opacity:0.9; }
      .fill { height:100%; width:0%; transition: width 120ms linear; }
      .fill.chunk { background: linear-gradient(90deg, #34d399, #10b981); }
      .fill.speech { background: linear-gradient(90deg, #60a5fa, #3b82f6); opacity: 0.75; }
      .fill.sil { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
      .fill.target { background: linear-gradient(90deg, #f59e0b, #f97316); }
      .btn { border:1px solid #d4d4d8; border-radius:8px; padding:6px 8px; background:#fff; cursor:pointer; }
      /* Compact icon-only buttons (emoji size) */
      .btn.icon { padding:4px 6px; min-width:auto; width:auto; height:32px; display:inline-flex; align-items:center; justify-content:center; line-height:1; font-size:18px; }
      /* Compact input fields: keep single line and truncate */
      input.btn { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      /* Inline toast bubble */
      .toast-inline { position: fixed; background: rgba(17,24,39,.96); color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; line-height:1.2; box-shadow:0 2px 10px rgba(0,0,0,.2); opacity:0; transform: translate(-50%, -6px); transition: opacity .18s ease, transform .18s ease; z-index: 2147483000; pointer-events: none; }
      .toast-inline.show { opacity:.98; transform: translate(-50%, -12px); }
      .btn:disabled { opacity:.6; cursor:not-allowed; }
      .title-grad { color: #0f172a; }
      /* Settings visibility: strong default hide; explicit show when settings-open */
      .settings-only { display: none !important; }
      #app.settings-open .settings-only { display: block !important; }
      #app.settings-open .row.settings-only { display: flex !important; }
      #app.settings-open select.settings-only,
      #app.settings-open input.settings-only,
      #app.settings-open label.settings-only { display: block !important; }
      /* Hide/show the whole Settings card via CSS to avoid JS desync */
      #params { display: none !important; }
      #app.settings-open #params { display: block !important; }

      /* iPhone XR / small-screen optimizations */
      :root {
        /* allow the page to extend under the notch and home indicator */
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }
      body { padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) calc(12px + var(--safe-bottom)) calc(12px + var(--safe-left)); }

      /* Prevent iOS zoom on inputs: keep font-size >= 16px */
      input, select, button { font-size: 16px; }

      @media (max-width: 480px) {
        h1 { font-size: 18px; white-space: normal; }
        .row { gap: 8px; }
        .btn, input.btn, select.btn { min-height: 44px; padding: 10px 12px; width: 100%; }
        /* Do not stretch icon buttons on mobile */
        .btn.icon { min-height: 36px; height: 36px; width: auto; padding: 6px; }
        .session-row-1 .btn.icon, .session-row-2 .btn.icon { width:auto; flex:0 0 auto; }
        /* turn forms and settings to single-column */
        .form-grid { grid-template-columns: 1fr; row-gap: 8px; }
        /* Ensure items manually placed into col 2 span full width on mobile */
        .form-grid > *[style*="grid-column:2"] { grid-column: 1 / -1 !important; }
        /* Make meters a bit taller for touch visibility */
        .bar { height: 10px; }
        /* Audio element full width */
        #audio-chunks audio { max-width: 100%; }
        /* Space for iOS bottom bar */
        #app { padding-bottom: calc(10px + var(--safe-bottom)); }
        /* Auth card controls stack nicely */
        #auth-card .row .btn { flex: 1 1 auto; }
      }
    
  /* Monitoring mode tweaks */
  body[data-page-mode="monitoring"] #params { display:none !important; }
  body[data-page-mode="monitoring"] #btn-settings { display:none !important; }
</style>
</head>
<body data-app-version="3.0.103" data-page-mode="monitoring">
    <!-- Auth Card -->
    <div id="auth-card" class="card stack" style="margin-bottom:10px;">
      <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
        <b class="title-grad">Authorization</b>
        <span id="srv-name" style="color:#475569;">&nbsp;(<span id="srv-host"></span>)</span>
      </div>
      <div class="form-grid">
        <label for="base-url">API URL</label>
        <input id="base-url" class="btn" type="text" placeholder="https://voice.stratospace.fun" />
        <label for="login">Login</label>
        <input id="login" class="btn" type="text" placeholder="user@example.com" />
        <label for="password">Password</label>
        <input id="password" class="btn" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="row" style="gap:8px;">
        <button id="btn-login" class="btn">üîê Login</button>
        <button id="btn-logout" class="btn">üö™ Logout</button>
        <small id="auth-status" style="color:#475569;"></small>
      </div>
    </div>

    <div id="app" style="display:none;">
    <h1 id="app-title">WebRTC Audio Capture with Silence Detection</h1>
    <!-- Rainbow header with user and status above buttons -->
    <div class="row" style="justify-content:space-between; align-items:center; margin:4px 0 2px 0;">
      <small id="current-user" class="rainbow-text" style="margin-right:8px;"></small>
      <small id="rec-status" class="rainbow-text" aria-live="polite">Idle</small>
    </div>
    <!-- Toolbar (duplicated from Settings) -->
    <div class="row toolbar" style="gap:10px; margin:6px 0; flex-wrap: wrap;">
      <button id="start-btn" class="btn icon-on-small" data-icon="‚ñ∂" aria-label="New" title="Create new session and record"><span class="lbl">‚ñ∂ New</span></button>
      <button id="record-btn" class="btn icon-on-small" data-icon="‚è∫" aria-label="Rec" title="Record into active session"><span class="lbl">‚è∫ Rec</span></button>
      <button id="chunk-btn" class="btn icon-on-small" data-icon="‚úÇÔ∏è" aria-label="Cut" title="Cut" disabled><span class="lbl">‚úÇÔ∏è Cut</span></button>
      <button id="pause-btn" class="btn icon-on-small" data-icon="‚è∏Ô∏è" aria-label="Pause" title="Pause" disabled><span class="lbl">‚è∏Ô∏è Pause</span></button>
      <button id="btn-done-button" class="btn icon-on-small" data-icon="‚úÖ" aria-label="Done" title="Finish recording and close session"><span class="lbl">‚úÖ Done</span></button>
      <button id="btn-choose-file" class="btn icon-on-small" data-icon="‚¨Ü" aria-label="Upload" title="Upload"><span class="lbl">‚¨Ü Upload</span></button>
      <button id="btn-reset" class="btn icon-on-small" data-icon="‚Üª" aria-label="Reset" title="Reset settings to default"><span class="lbl">‚Üª Reset</span></button>
      <button id="btn-logout-app" class="btn icon-on-small" data-icon="‚éã" title="Logout"><span class="lbl">‚éã Logout</span></button>
      <span style="flex:1 1 auto;"></span>
    </div>
    <!-- Hidden native input to avoid 'No file chosen' text; triggered by Upload in toolbar -->
    <input id="file-input" class="btn" type="file" accept="audio/*" style="display:none;" />
    <!-- Settings panel moved near the controls above -->
    <style>
      .rainbow-text { color: #1f2937; font-weight: 600; }
      .mini-bar { width: 120px; height: 8px; border-radius: 999px; background: #e5e7eb; overflow: hidden; }
      .mini-bar .mini-fill { height: 100%; width: 0%; background: linear-gradient(90deg,#22c55e,#16a34a); }
      .mini-bar.mic2 .mini-fill { background: linear-gradient(90deg,#84cc16,#4d7c0f); }
      .mini-bar.chunk .mini-fill { background: linear-gradient(90deg,#60a5fa,#2563eb); }
      #compact-mini-row { display:flex; gap:12px; align-items:center; margin:6px 0; }
      #session-card .session-row-1, #session-card .session-row-2 { gap: 6px; flex-wrap: wrap; }
      #session-id, #session-name { min-width: 0; flex: 1 1 auto; }

      /* compact list styling for Telegram Mini App */
      #audio-chunks { list-style: none; padding-left: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
      #audio-chunks li { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
      #audio-chunks audio { width: 100%; max-width: 360px; }

      .compact-inputs .mic-group { grid-template-columns: minmax(56px, 70px) 1fr; }
      .compact-inputs .mic-row { flex-wrap: wrap; gap: 6px; }
      .compact-inputs select { min-width: 0; flex: 1 1 220px; }
      .compact-inputs .mic-monitor-ctl { flex: 0 0 auto; }
      .compact-inputs .mic-monitor-ctl .monitor-label { display:inline; font-size:12px; color:#64748b; }
      .compact-inputs .mic-meter { margin-top: 4px; }
      .compact-inputs .mic-slider { margin-top: 4px; gap: 6px; align-items: center; }
      .compact-inputs .mic-slider small { color:#475569; }
      .compact-inputs .spk-group { grid-template-columns: minmax(70px, 90px) 1fr; }
    </style>

    <!-- Mini meters removed by request -->

    <div id="monitor-inputs" class="card stack" style="margin-top:8px;">
      <div><b class="title-grad">Inputs</b></div>
      <div id="mic-1-group" class="form-grid mic-group" data-mic-index="1">
        <label id="lbl-mic-1"><b class="title-grad">Mic 1:</b></label>
        <div id="mic-1-meter-wrap" class="row mic-meter" style="grid-column:2/span 1;">
          <div class="bar">
            <div id="bar-mic-1-level" class="fill" style="background:linear-gradient(90deg,#22c55e,#16a34a);"></div>
            <div id="tick-mic-1-noise" class="bar-tick"></div>
            <div id="tick-mic-1-gate" class="bar-tick gate"></div>
          </div>
        </div>
      </div>

      <div id="mic-2-group" class="form-grid mic-group" data-mic-index="2" style="display:none;">
        <label id="lbl-mic-2"><b class="title-grad">Mic 2:</b></label>
        <div id="mic-2-meter-wrap" class="row mic-meter" style="grid-column:2/span 1;">
          <div class="bar">
            <div id="bar-mic-2-level" class="fill" style="background:linear-gradient(90deg,#84cc16,#4d7c0f);"></div>
            <div id="tick-mic-2-noise" class="bar-tick"></div>
            <div id="tick-mic-2-gate" class="bar-tick gate"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="counters" class="card stack" style="margin-top:10px;">
      <div><b class="title-grad">Current Chunks</b></div>
      <div class="row" style="gap:8px; align-items:center; margin-top:6px;">
        <small style="min-width:56px; color:#475569;">chunk:</small>
        <small style="min-width:140px; white-space:nowrap; color:#475569;">
          <span id="c-chunk-speech" style="color:#2563eb;">00:00.0</span>/<span id="c-chunk">00:00.0</span>
        </small>
        <div class="bar" id="bar-chunk-wrap" style="position:relative; flex:1;">
          <div id="bar-chunk" class="fill chunk"></div>
          <!-- speech overlay on top of chunk bar -->
          <div id="bar-chunk-speech" class="fill speech" style="position:absolute; top:0; left:0; height:100%; width:0%"></div>
          <div id="bar-chunk-ticks" style="position:absolute; inset:0; pointer-events:none;">
            <div id="tick-min" style="position:absolute; top:0; bottom:0; width:2px; background:#475569; left:0%"></div>
          </div>
        </div>
      </div>
      <div id="chunk-legend" style="font-size:12px;color:#64748b;">¬∑ tick = min chunk ¬∑ 100% = max chunk duration</div>
	      <!-- Per-mic chunk readout -->
	      <div id="per-track">
	        <div id="per-track-list"></div>
	      </div>
      <div>silence duration: <b><span id="c-silence">00:00.0</span></b> / <b><span id="c-silence-req">‚Äî s</span></b> <small id="c-silence-note"></small>
        <div class="bar" id="bar-sil-wrap" style="position:relative;"><div id="bar-sil" class="fill sil"></div>
          <div id="tick-sil-min" style="position:absolute; top:0; bottom:0; width:2px; background:#475569; left:0%"></div>
        </div>
        <div style="font-size:12px;color:#64748b;">100% = max silence duration ¬∑ tick = min silence duration</div>
      </div>
      
    </div>
    <!-- Session parameters card -->
    <div id="session-card" class="card stack" style="margin-top:10px;">
      <div><b class="title-grad">Session</b></div>
      <div class="row session-row-1" style="gap:8px; align-items:center;">
        <input id="session-id" class="btn" type="text" placeholder="Session ID" aria-label="Session ID" title="Current session ID (read-only until created)." style="min-width:0; flex: 1 1 auto;" />
        <button id="btn-open-session-link" class="btn icon" title="Open public session link">‚Üó</button>
      </div>
      <div class="row session-row-2" style="gap:8px; align-items:center;">
        <div class="row" style="gap:6px; align-items:center; flex:1 1 auto; flex-wrap:nowrap;">
          <input id="session-name" class="btn" type="text" placeholder="Session name" aria-label="Session name" title="Session display name (editable)." style="min-width:0; flex:1 1 auto;" />
          <button id="btn-copy-session-name" class="btn icon" title="Copy session name">‚øª</button>
          <small id="session-name-status" style="min-width:12px;color:#475569;" aria-live="polite"></small>
        </div>
      </div>
      <div class="row" style="gap:8px; align-items:center;">
        <small id="session-opened-at" style="color:#64748b;" aria-live="polite"></small>
      </div>
    </div>

    <!-- Completed chunks and upload card -->
    <div id="chunks-card" class="card stack" style="margin-top:10px;">
      <div><b class="title-grad">Complited Audio Chunks</b></div>
      <ul id="audio-chunks"></ul>
      <div class="row" style="gap:8px; align-items:center; margin-top:8px;">
        <button id="btn-upload-all" class="btn" title="Upload all not uploaded chunks">‚¨Ü‚¨Ü‚¨Ü</button>
      </div>
    </div>
    <div class="card stack" style="margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="btn-test-mode" class="btn" title="Enable testing mode (monitoring only, no recording).">Test audio</button>
        <small style="color:#64748b;">Monitoring only (no recording)</small>
      </div>
    </div>
    </div> <!-- /#app -->
    
	    <script src="webrtc-voicebot-lib.js"></script>
</body>
</html>
